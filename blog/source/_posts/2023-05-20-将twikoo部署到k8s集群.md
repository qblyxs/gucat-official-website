---
title: å°†twikooéƒ¨ç½²åˆ°k8sé›†ç¾¤
description: åœ¨kubernetesé›†ç¾¤ä¸­éƒ¨ç½²twikooé¡¹ç›®çš„é…ç½®æ¸…å•
mathjax: true
tags:
  - åº”ç”¨éƒ¨ç½²
  - äº‘å‡½æ•°
  - kubernetes
categories:
  - function
abbrlink: 20230520f
sticky: 90
swiper_index: 90
date: 2023-05-20 18:19:03
---

## 1. é¡¹ç›®ä»‹ç»
<!-- tab -->
åšé¡¹ç›®ä»‹ç»éƒ½æ˜¯åºŸè¯äº†,å®˜ç½‘çš„ä»‹ç»æ¯”æˆ‘ä»‹ç»çš„å¥½,ç›´æ¥è´´è¿‡æ¥äº†:
{% link twikoo, https://twikoo.js.org/, https://twikoo.js.org/assets/logo.5707582f.png %}
<!-- endtab -->

## 2. éƒ¨ç½²åˆ°k8sé›†ç¾¤
### 2.1. é¡¹ç›®åˆ†æ
<!-- tab -->
1. å®˜æ–¹æä¾›äº†dockeré•œåƒ,å¯ä»¥ç›´æ¥ä½¿ç”¨
2. å®˜æ–¹çš„dockeréƒ¨ç½²å‘½ä»¤`docker run --name twikoo -e TWIKOO_THROTTLE=1000 -p 8080:8080 -v ${PWD}/data:/app/data -d imaegoo/twikoo`,æˆ‘ä»¬è¿›è¡Œåˆ†æ
3. éœ€è¦æŒ‡å®šç¯å¢ƒå˜é‡`TWIKOO_THROTTLE`å’ŒæŒ‚è½½æ•°æ®å·`/app/data`
4. å®¹å™¨å†…æœåŠ¡ç«¯å£ä¸º8080
<!-- endtab -->
### 2.2. é…ç½®æ¸…å•
### 2.2.1 é¦–å…ˆæŒ‡å®šå‘½åç©ºé—´
è¿™é‡Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºä¸€ä¸ª`twikoo`å‘½åç©ºé—´
```yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: twikoo
```
### 2.2.2 åˆ›å»ºDeployment
```yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: twikoo-deployment
  namespace: twikoo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: twikoo
  template:
    metadata:
      labels:
        app: twikoo
    spec:
      nodeSelector:
        twikoo: enable
      containers:
      - name: twikoo
        image: imaegoo/twikoo
        imagePullPolicy: IfNotPresent
        env:
        - name: TWIKOO_THROTTLE
          value: "1000"
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
      volumes:
      - name: data-volume
        hostPath:
          path: /mnt/twikoo/data
---
```
<!-- tab -->
1. æŒ‡å®šäº†`replicas: 1`è¡¨ç¤ºåªåˆ›å»ºä¸€ä¸ªpod
2. appçš„æ ‡ç­¾ä¸º`app: twikoo`
3. æŒ‡å®šäº†`nodeSelector: twikoo: enable`è¡¨ç¤ºåªåœ¨æ‹¥æœ‰`twikoo: enable`æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºpod
4. æŒ‡å®šäº†ç¯å¢ƒå˜é‡`TWIKOO_THROTTLE`çš„å€¼ä¸º`1000`
5. æŒ‡å®šäº†å®¹å™¨å†…çš„ç«¯å£ä¸º`8080`
6. æŒ‚è½½äº†ä¸€ä¸ªåä¸º`data-volume`çš„æ•°æ®å·,æŒ‚è½½åˆ°äº†å®¹å™¨å†…çš„`/app/data`ç›®å½•
7. æŒ‡å®šäº†`hostPath: /mnt/twikoo/data`è¡¨ç¤ºå°†å®¿ä¸»æœºçš„`/mnt/twikoo/data`ç›®å½•æŒ‚è½½åˆ°äº†`data-volume`æ•°æ®å·
8. é•œåƒæ‹‰å–ç­–ç•¥ä¸º`IfNotPresent`,è¡¨ç¤ºå¦‚æœæœ¬åœ°æ²¡æœ‰é•œåƒå°±æ‹‰å–,å¦‚æœæœ‰å°±ä¸æ‹‰å–
<!-- endtab -->
### 2.2.3 åˆ›å»ºService
```yaml
---
apiVersion: v1
kind: Service
metadata:
  name: twikoo
  namespace: twikoo
spec:
  selector:
    app: twikoo
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
```
<!-- tab -->
1. æŒ‡å®šäº†`selector: app: twikoo`è¡¨ç¤ºå°†`app: twikoo`çš„podåŠ å…¥åˆ°serviceä¸­
2. æŒ‡å®šäº†ç«¯å£`8080`
3. æŒ‡å®šäº†`type: ClusterIP`è¡¨ç¤ºåˆ›å»ºä¸€ä¸ª`ClusterIP`ç±»å‹çš„service
4. `ClusterIP`ç±»å‹çš„serviceåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®,ä½†æˆ‘å¯ä»¥é…ç½®ingressæ¥è®©å¤–éƒ¨è®¿é—®
5. `ClusterIP`ç±»å‹çš„serviceçš„è®¿é—®ç«¯å£ä¸º`8080`
6. `ClusterIP`ç±»å‹çš„serviceçš„è®¿é—®åœ°å€ä¸º`twikoo.twikoo.svc.cluster.local`
<!-- endtab -->
### 2.2.4 åˆ›å»ºIngress
```yaml
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations: {}
  name: twikoo.gucat.vip
  namespace: twikoo
spec:
  ingressClassName: nginx
  rules:
    - host: twikoo.gucat.vip
      http:
        paths:
          - backend:
              service:
                name: twikoo
                port:
                  number: 8080
            path: /
            pathType: Prefix
---
```
<!-- tab -->
1. æŒ‡å®šäº†`ingressClassName: nginx`è¡¨ç¤ºä½¿ç”¨ingress-nginxä½œä¸ºingress
2. é…ç½®äº†`host: twikoo.gucat.vip`è¡¨ç¤ºè®¿é—®`twikoo.gucat.vip`åŸŸåæ—¶,å°†è¯·æ±‚è½¬å‘åˆ°`twikoo`service
3. tlsæ²¡æœ‰é…ç½®åœ¨è¿™é‡Œ,æˆ‘æ˜¯åœ¨ingress-nginxçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„é»˜è®¤è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯æ³›åŸŸåè¯ä¹¦,å¯ä»¥æ”¯æŒæ‰€æœ‰çš„å­åŸŸå
<!-- endtab -->
### 2.3 éƒ¨ç½²twikooåˆ°k8sé›†ç¾¤
#### 2.3.1 éƒ¨ç½²æœåŠ¡
```bash
sudo mkdir -p /mnt/twikoo/data
kubectl apply -f namespace.yaml
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f ingress.yaml
```
#### 2.3.2 æŸ¥çœ‹æœåŠ¡
```bash
kubectl get all -n twikoo
```
```bash
[root@k8s-master1 ~]# kubectl get all -n twikoo
NAME                                    READY   STATUS    RESTARTS   AGE
pod/twikoo-deployment-5d8bd749b-5djhx   1/1     Running   0          30h

NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/twikoo   ClusterIP   100.55.77.238   <none>        8080/TCP   3d4h

NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/twikoo-deployment   1/1     1            1           3d4h

NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/twikoo-deployment-5d8bd749b   1         1         1       30h
replicaset.apps/twikoo-deployment-d459f49bf   0         0         0       3d4h
```
{% note success flat %}ğŸ‰ğŸ‰ğŸ‰è‡³æ­¤twikooæˆåŠŸéƒ¨ç½²åˆ°äº†kubernetesé›†ç¾¤ä¸­ğŸ‘ğŸ‘ğŸ‘{% endnote %}
