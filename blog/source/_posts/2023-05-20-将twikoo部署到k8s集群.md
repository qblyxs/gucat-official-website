---
title: 将twikoo部署到k8s集群
description: 在kubernetes集群中部署twikoo项目的配置清单
mathjax: true
tags:
  - 应用部署
  - 云函数
  - kubernetes
categories:
  - function
abbrlink: 20230520f
sticky: 90
swiper_index: 90
date: 2023-05-20 18:19:03
---

## 1. 项目介绍
<!-- tab -->
项目介绍内容直接贴出官方的,官网的介绍比我介绍的好,直接贴过来了:
{% link twikoo, https://twikoo.js.org/, https://twikoo.js.org/assets/logo.5707582f.png %}
<!-- endtab -->

## 2. 部署到k8s集群
### 2.1. 项目分析
<!-- tab -->
1. 官方提供了docker镜像,可以直接使用
2. 官方的docker部署命令`docker run --name twikoo -e TWIKOO_THROTTLE=1000 -p 8080:8080 -v ${PWD}/data:/app/data -d imaegoo/twikoo`,我们进行分析
3. 需要指定环境变量`TWIKOO_THROTTLE`和挂载数据卷`/app/data`
4. 容器内服务端口为8080
<!-- endtab -->
### 2.2. 配置清单
### 2.2.1 首先指定命名空间
这里我们直接创建一个`twikoo`命名空间
```yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: twikoo
```
### 2.2.2 创建Deployment
```yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: twikoo-deployment
  namespace: twikoo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: twikoo
  template:
    metadata:
      labels:
        app: twikoo
    spec:
      nodeSelector:
        twikoo: enable
      containers:
      - name: twikoo
        image: imaegoo/twikoo
        imagePullPolicy: IfNotPresent
        env:
        - name: TWIKOO_THROTTLE
          value: "1000"
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
      volumes:
      - name: data-volume
        hostPath:
          path: /mnt/twikoo/data
---
```
<!-- tab -->
1. 指定了`replicas: 1`表示只创建一个pod
2. app的标签为`app: twikoo`
3. 指定了`nodeSelector: twikoo: enable`表示只在拥有`twikoo: enable`标签的节点上创建pod
4. 指定了环境变量`TWIKOO_THROTTLE`的值为`1000`
5. 指定了容器内的端口为`8080`
6. 挂载了一个名为`data-volume`的数据卷,挂载到了容器内的`/app/data`目录
7. 指定了`hostPath: /mnt/twikoo/data`表示将宿主机的`/mnt/twikoo/data`目录挂载到了`data-volume`数据卷
8. 镜像拉取策略为`IfNotPresent`,表示如果本地没有镜像就拉取,如果有就不拉取
<!-- endtab -->
### 2.2.3 创建Service
```yaml
---
apiVersion: v1
kind: Service
metadata:
  name: twikoo
  namespace: twikoo
spec:
  selector:
    app: twikoo
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
```
<!-- tab -->
1. 指定了`selector: app: twikoo`表示将`app: twikoo`的pod加入到service中
2. 指定了端口`8080`
3. 指定了`type: ClusterIP`表示创建一个`ClusterIP`类型的service
4. `ClusterIP`类型的service只能在集群内部访问,但我可以配置ingress来让外部访问
5. `ClusterIP`类型的service的访问端口为`8080`
6. `ClusterIP`类型的service的访问地址为`twikoo.twikoo.svc.cluster.local`
<!-- endtab -->
### 2.2.4 创建Ingress
```yaml
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations: {}
  name: twikoo.gucat.vip
  namespace: twikoo
spec:
  ingressClassName: nginx
  rules:
    - host: twikoo.gucat.vip
      http:
        paths:
          - backend:
              service:
                name: twikoo
                port:
                  number: 8080
            path: /
            pathType: Prefix
---
```
<!-- tab -->
1. 指定了`ingressClassName: nginx`表示使用ingress-nginx作为ingress
2. 配置了`host: twikoo.gucat.vip`表示访问`twikoo.gucat.vip`域名时,将请求转发到`twikoo`service
3. tls没有配置在这里,我是在ingress-nginx的配置文件中配置的默认证书,该证书是泛域名证书,可以支持所有的子域名
<!-- endtab -->
### 2.3 部署twikoo到k8s集群
#### 2.3.1 部署服务
```bash
sudo mkdir -p /mnt/twikoo/data
kubectl apply -f namespace.yaml
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f ingress.yaml
```
#### 2.3.2 查看服务
```bash
kubectl get all -n twikoo
```
```bash
[root@k8s-master1 ~]# kubectl get all -n twikoo
NAME                                    READY   STATUS    RESTARTS   AGE
pod/twikoo-deployment-5d8bd749b-5djhx   1/1     Running   0          30h

NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/twikoo   ClusterIP   100.55.77.238   <none>        8080/TCP   3d4h

NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/twikoo-deployment   1/1     1            1           3d4h

NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/twikoo-deployment-5d8bd749b   1         1         1       30h
replicaset.apps/twikoo-deployment-d459f49bf   0         0         0       3d4h
```
{% note success flat %}🎉🎉🎉至此twikoo成功部署到了kubernetes集群中👏👏👏{% endnote %}
